<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Daily English Pro</title>
    <style>
        :root {
            --primary: #007AFF;
            --bg: #F2F2F7;
            --card-bg: #FFFFFF;
            --text: #000000;
            --red: #FF3B30;
            --green: #34C759;
            --yellow: #FFCC00;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            color: var(--text);
        }

        /* HEADER & CONTROLES */
        .header {
            background: rgba(242, 242, 247, 0.95);
            backdrop-filter: blur(10px);
            padding: 40px 15px 10px 15px;
            border-bottom: 1px solid #ccc;
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .header-top {
            display: flex; justify-content: space-between; align-items: center;
        }

        /* SEARCH BAR */
        .search-container {
            width: 100%;
        }
        .search-input {
            width: 100%;
            padding: 10px 15px;
            border-radius: 12px;
            border: 1px solid #ddd;
            background: #E5E5EA;
            font-size: 14px;
            box-sizing: border-box; /* Garante que padding n√£o estoure a largura */
            outline: none;
        }
        .search-input:focus { background: #fff; border-color: var(--primary); }

        /* SCROLL CATEGORIAS */
        .cat-scroll {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            scrollbar-width: none;
            padding-bottom: 5px;
        }
        .cat-scroll::-webkit-scrollbar { display: none; }

        .cat-chip {
            background: #E5E5EA;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            color: #333;
            border: 1px solid transparent;
            transition: 0.2s;
        }
        .cat-chip.active {
            background: #000;
            color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        /* √ÅREA DE CONTE√öDO */
        .view-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 120px;
        }

        /* FEED DE CARDS */
        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.06);
            position: relative;
            border-left: 5px solid transparent;
            transition: transform 0.2s;
        }
        
        .card.hard-mode { border-left: 5px solid var(--red); }

        /* NUMERA√á√ÉO DO CARD */
        .card-number {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 11px;
            color: #ccc;
            font-weight: 600;
        }

        .card-header-row {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px;
            padding-right: 30px; /* Espa√ßo para o n√∫mero */
        }
        .card-cat { font-size: 10px; font-weight: 800; color: #999; text-transform: uppercase; letter-spacing: 1px; }
        
        .toggle-hard-btn {
            background: none; border: none; font-size: 12px; color: #ccc;
        }
        .card.hard-mode .toggle-hard-btn { color: var(--red); font-weight: bold; }

        .en-text { font-size: 24px; font-weight: 800; color: var(--primary); margin-bottom: 10px; line-height: 1.2; }
        .pt-text { font-size: 18px; color: #333; margin-bottom: 15px; font-weight: 500; }
        
        .ctx-box {
            background: #f9f9f9; padding: 12px; border-radius: 10px;
            font-size: 13px; color: #555; line-height: 1.4; margin-bottom: 15px;
        }

        /* POST-ITS */
        .post-it-container {
            display: flex; flex-direction: column; gap: 8px; margin-top: 10px;
        }
        .post-it {
            background: #FFF8E1;
            border-left: 3px solid #FFC107;
            padding: 10px; border-radius: 6px;
            font-size: 13px; font-family: monospace; color: #444;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* A√á√ïES DO CARD */
        .card-actions {
            display: flex; gap: 10px; margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px;
        }
        .act-btn {
            background: #F0F0F5; border: none; border-radius: 15px;
            padding: 8px 14px; font-size: 13px; font-weight: 600; color: #333;
            display: flex; align-items: center; gap: 5px; cursor: pointer;
        }
        .act-btn:active { opacity: 0.7; }

        /* BOT√ÉO GERAR */
        .gen-btn {
            background: #000; color: white; width: 100%; border: none;
            padding: 18px; border-radius: 18px; font-size: 16px; font-weight: 700;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2); margin-bottom: 30px;
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .gen-btn:active { transform: scale(0.98); }

        /* BACKUP AREA */
        .backup-area {
            margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center;
        }
        .backup-btn {
            background: #E5E5EA; color: #333; border: 1px solid #ccc;
            padding: 10px 20px; border-radius: 10px; font-size: 12px; margin: 0 5px; cursor: pointer;
        }

        /* SRS MODE */
        .review-mode-container {
            height: 100%; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; text-align: center;
        }
        .flashcard {
            background: white; width: 90%; max-width: 350px;
            padding: 40px 20px; border-radius: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            min-height: 300px; display: flex; flex-direction: column; justify-content: center;
        }
        .hidden-content { display: none; margin-top: 20px; animation: fadeIn 0.3s; }
        .hidden-content.visible { display: block; }
        .srs-btns { display: flex; gap: 10px; justify-content: center; margin-top: 25px; }
        .srs-btn { padding: 15px 0; width: 100px; border-radius: 15px; border: none; font-weight: bold; color: white; font-size: 14px; }
        
        /* NAVBAR */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%;
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            border-top: 1px solid #ccc; display: flex; height: 80px;
            justify-content: space-around; padding-top: 10px; z-index: 100;
        }
        .nav-item {
            background: none; border: none; color: #999;
            font-size: 10px; display: flex; flex-direction: column; align-items: center; gap: 4px;
        }
        .nav-item.active { color: var(--primary); }
        .badge {
            background: var(--red); color: white; font-size: 10px; 
            padding: 2px 6px; border-radius: 10px; position: absolute; margin-top: -5px; margin-left: 15px;
        }

        /* MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); z-index: 200;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: 0.2s;
        }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        .modal { background: white; width: 85%; max-width: 320px; border-radius: 20px; padding: 20px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none !important; }

    </style>
</head>
<body>

    <div id="headerExplore" class="header">
        <div class="header-top">
            <h2 style="margin:0; font-size: 22px;">Meus Cards</h2>
        </div>
        
        <div class="search-container">
            <input type="text" id="searchInput" class="search-input" placeholder="üîç Buscar express√£o..." onkeyup="handleSearch(this.value)">
        </div>

        <div class="cat-scroll">
            <button class="cat-chip active" onclick="filterCat('all', this)">Todos</button>
            <button class="cat-chip" onclick="filterCat('Relacionamento', this)">Relacionamento</button>
            <button class="cat-chip" onclick="filterCat('Fam√≠lia', this)">Fam√≠lia</button>
            <button class="cat-chip" onclick="filterCat('Objetos', this)">Objetos</button>
            <button class="cat-chip" onclick="filterCat('Lugares', this)">Lugares</button>
            <button class="cat-chip" onclick="filterCat('Trabalho', this)">Trabalho</button>
            <button class="cat-chip" onclick="filterCat('Estudos', this)">Estudos</button>
            <button class="cat-chip" onclick="filterCat('Elei√ß√µes', this)">Elei√ß√µes</button>
            <button class="cat-chip" onclick="filterCat('Economia', this)">Economia</button>
        </div>
    </div>

    <div id="viewExplore" class="view-container">
        
        <button class="gen-btn" onclick="generateCard()">
            <span>‚ú®</span> Gerar Nova (Sem Repetir)
        </button>

        <div id="feedList">
            <div style="text-align:center; color:#999; margin-top:40px;">Carregando...</div>
        </div>

        <div class="backup-area">
            <p style="font-size:10px; color:#999; margin-bottom:10px;">GERENCIAR DADOS</p>
            <button class="backup-btn" onclick="backupData()">‚¨áÔ∏è Fazer Backup</button>
            <button class="backup-btn" onclick="document.getElementById('restoreFile').click()">‚¨ÜÔ∏è Restaurar</button>
            <input type="file" id="restoreFile" style="display:none;" onchange="restoreData(this)">
        </div>

    </div>

    <div id="viewReview" class="view-container hidden" style="background:#f0f0f5;">
        <div class="review-mode-container" id="reviewContainer">
            </div>
    </div>

    <div id="modalEx" class="modal-overlay">
        <div class="modal">
            <h3>Novo Exemplo</h3>
            <p style="font-size:12px; color:#666;">Exemplo gerado para contexto adicional:</p>
            <div style="background:#f2f2f7; padding:15px; border-radius:10px; margin:15px 0; font-style:italic;" id="modalText">...</div>
            <div style="display:flex; gap:10px;">
                <button onclick="cycleModal()" style="flex:1; padding:10px; border:none; border-radius:8px; background:#ddd;">üîÑ Outro</button>
                <button onclick="speakModal()" style="padding:10px; border:none; border-radius:8px; background:#ddd;">üîä</button>
            </div>
            <button onclick="saveModal()" style="width:100%; margin-top:15px; background:black; color:white; padding:12px; border:none; border-radius:10px; font-weight:bold;">Salvar Post-it</button>
            <button onclick="closeModal()" style="width:100%; margin-top:5px; background:none; color:red; padding:10px; border:none;">Cancelar</button>
        </div>
    </div>

    <div class="bottom-nav">
        <button class="nav-item active" id="navExp" onclick="switchView('explore')">
            <span style="font-size:24px;">üóÇÔ∏è</span>
            <span>Explorar</span>
        </button>
        
        <button class="nav-item" id="navRev" onclick="switchView('review')">
            <span style="font-size:24px;">üß†</span>
            <span>Revisar <span id="revBadge" class="badge hidden">0</span></span>
        </button>
    </div>

    <script>
        // --- BANCO DE DADOS (Expandido) ---
        const db = [
            // RELACIONAMENTO
            { id: 101, cat: "Relacionamento", en: "We need to talk", pt: "Precisamos conversar (DR)", ctx: "Geralmente indica not√≠cias ruins ou t√©rmino.", exs: ["Can you come over? We need to talk.", "She sent a text: 'we need to talk'."] },
            { id: 102, cat: "Relacionamento", en: "He stood me up", pt: "Ele me deu um bolo", ctx: "Quando algu√©m n√£o aparece no encontro marcado.", exs: ["I waited for an hour but he stood me up.", "Don't stand me up again."] },
            { id: 103, cat: "Relacionamento", en: "I have a crush on her", pt: "Tenho uma queda por ela", ctx: "Estar interessado romanticamente em algu√©m.", exs: ["Everybody knows he has a crush on the teacher.", "It's just a silly crush."] },
            { id: 104, cat: "Relacionamento", en: "We hit it off", pt: "Nos demos bem de cara", ctx: "Quando a conex√£o √© imediata no primeiro encontro.", exs: ["We met at the party and really hit it off.", "I didn't think we would hit it off."] },
            { id: 105, cat: "Relacionamento", en: "Third wheel", pt: "Segurar vela", ctx: "Ser a pessoa sobrando num casal.", exs: ["I don't want to go to the movies and be a third wheel.", "Being a third wheel is awkward."] },
            { id: 106, cat: "Relacionamento", en: "Ghosting", pt: "Sumir (dar um v√°cuo eterno)", ctx: "Parar de responder mensagens repentinamente.", exs: ["I thought he liked me, but he is ghosting me.", "Ghosting is so immature."] },

            // FAM√çLIA
            { id: 201, cat: "Fam√≠lia", en: "Like father, like son", pt: "Tal pai, tal filho", ctx: "Similaridade de comportamento ou apar√™ncia.", exs: ["He is stubborn. Like father, like son.", "They both assume the same pose. Like father, like son."] },
            { id: 202, cat: "Fam√≠lia", en: "I was raised in...", pt: "Eu fui criado em...", ctx: "Falar sobre onde cresceu/foi educado.", exs: ["I was raised in Texas.", "She was raised by her aunt."] },
            { id: 203, cat: "Fam√≠lia", en: "Black sheep", pt: "Ovelha negra", ctx: "O membro diferente ou problem√°tico da fam√≠lia.", exs: ["He is the black sheep of the family.", "Every family has a black sheep."] },
            { id: 204, cat: "Fam√≠lia", en: "Runs in the family", pt: "√â de fam√≠lia (gen√©tico)", ctx: "Caracter√≠stica comum a todos os parentes.", exs: ["Diabetes runs in the family.", "Red hair runs in the family."] },
            { id: 205, cat: "Fam√≠lia", en: "Look after", pt: "Cuidar de (algu√©m)", ctx: "Tomar conta de crian√ßas ou idosos.", exs: ["Can you look after my son tonight?", "I have to look after my grandma."] },

            // OBJETOS
            { id: 301, cat: "Objetos", en: "Power strip", pt: "R√©gua / Extens√£o", ctx: "Dispositivo com v√°rias tomadas.", exs: ["Plug the computer into the power strip.", "The power strip is overloaded."] },
            { id: 302, cat: "Objetos", en: "Coaster", pt: "Porta-copos", ctx: "Aquele apoio para n√£o manchar a mesa.", exs: ["Please use a coaster.", "Pass me a coaster for my beer."] },
            { id: 303, cat: "Objetos", en: "Clothespin", pt: "Pregador de roupa", ctx: "Usado para prender roupa no varal.", exs: ["We need more clothespins.", "Hold this with a clothespin."] },
            { id: 304, cat: "Objetos", en: "The remote is dead", pt: "O controle acabou a pilha", ctx: "Diz-se que eletr√¥nicos 'morreram' quando acaba a energia.", exs: ["My phone is dead.", "Is the remote dead again?"] },
            { id: 305, cat: "Objetos", en: "Plunger", pt: "Desentupidor", ctx: "Ferramenta essencial de banheiro.", exs: ["The toilet is clogged, get the plunger.", "Do you have a plunger?"] },

            // LUGARES
            { id: 401, cat: "Lugares", en: "Downtown", pt: "Centro da cidade", ctx: "√Årea comercial principal.", exs: ["I work downtown.", "Traffic downtown is terrible."] },
            { id: 402, cat: "Lugares", en: "Gated community", pt: "Condom√≠nio fechado", ctx: "Bairro residencial com portaria.", exs: ["They live in a gated community.", "Is it a gated community?"] },
            { id: 403, cat: "Lugares", en: "Two blocks away", pt: "A dois quarteir√µes", ctx: "Medida padr√£o de dist√¢ncia urbana.", exs: ["It's just two blocks away.", "The store is three blocks away."] },
            { id: 404, cat: "Lugares", en: "The suburbs", pt: "O sub√∫rbio (Residencial)", ctx: "Nos EUA, sub√∫rbio √© √°rea nobre/classe m√©dia, n√£o periferia pobre.", exs: ["We moved to the suburbs for the kids.", "Life in the suburbs is quiet."] },

            // TRABALHO
            { id: 501, cat: "Trabalho", en: "Let's call it a day", pt: "Vamos encerrar por hoje", ctx: "Fim do expediente.", exs: ["We are tired. Call it a day.", "Let's call it a day guys."] },
            { id: 502, cat: "Trabalho", en: "I'm swamped", pt: "Estou atolado", ctx: "Muito ocupado.", exs: ["I can't talk, I'm swamped.", "He is swamped with emails."] },
            { id: 503, cat: "Trabalho", en: "Touch base", pt: "Conversar rapidinho/Alinhar", ctx: "Entrar em contato para atualizar algo.", exs: ["Let's touch base next week.", "I just wanted to touch base with you."] },
            { id: 504, cat: "Trabalho", en: "Burnout", pt: "Esgotamento profissional", ctx: "Exaust√£o extrema pelo trabalho.", exs: ["She is suffering from burnout.", "Avoid burnout by taking breaks."] },

            // ESTUDOS
            { id: 601, cat: "Estudos", en: "My mind went blank", pt: "Deu um branco", ctx: "Esquecer tudo na hora.", exs: ["I saw the test and my mind went blank.", "Sorry, mind went blank."] },
            { id: 602, cat: "Estudos", en: "Pull an all-nighter", pt: "Passar a noite em claro", ctx: "Ficar acordado estudando.", exs: ["I have to pull an all-nighter.", "Don't pull an all-nighter before the test."] },
            { id: 603, cat: "Estudos", en: "Hit the books", pt: "Enfiar a cara nos livros", ctx: "Come√ßar a estudar s√©rio.", exs: ["Finals are coming, time to hit the books.", "I can't go out, I gotta hit the books."] },
            { id: 604, cat: "Estudos", en: "Dropout", pt: "Desistente / Abandonou", ctx: "Algu√©m que largou a escola/faculdade.", exs: ["He is a college dropout.", "Don't be a dropout."] },
            { id: 605, cat: "Estudos", en: "Ace the test", pt: "Gabaritar / Ir muito bem", ctx: "Tirar nota m√°xima.", exs: ["I think I aced the test.", "She aced the interview."] },

            // ELEI√á√ïES
            { id: 701, cat: "Elei√ß√µes", en: "It's a close race", pt: "A disputa est√° acirrada", ctx: "Candidatos quase empatados.", exs: ["Polls say it's a close race.", "It was a close race till the end."] },
            { id: 702, cat: "Elei√ß√µes", en: "Landslide victory", pt: "Vit√≥ria esmagadora", ctx: "Ganhar com muita vantagem.", exs: ["He won by a landslide.", "They are predicting a landslide victory."] },
            { id: 703, cat: "Elei√ß√µes", en: "Running for office", pt: "Candidatando-se a um cargo", ctx: "Participar da elei√ß√£o.", exs: ["Is she running for office?", "I'm running for mayor."] },
            { id: 704, cat: "Elei√ß√µes", en: "Voter turnout", pt: "Comparecimento √†s urnas", ctx: "Quantidade de pessoas que foram votar.", exs: ["Voter turnout was low this year.", "We need higher voter turnout."] },

            // ECONOMIA
            { id: 801, cat: "Economia", en: "Inflation is skyrocketing", pt: "A infla√ß√£o est√° disparando", ctx: "Subindo muito r√°pido.", exs: ["Gas prices are skyrocketing.", "Rents have skyrocketed here."] },
            { id: 802, cat: "Economia", en: "Money is tight", pt: "O or√ßamento est√° apertado", ctx: "Pouco dinheiro dispon√≠vel.", exs: ["We can't travel, money is tight.", "Money is tight this month."] },
            { id: 803, cat: "Economia", en: "Make ends meet", pt: "Fechar as contas (sobreviver)", ctx: "Conseguir pagar tudo com o sal√°rio.", exs: ["It's hard to make ends meet these days.", "She works two jobs to make ends meet."] },
            { id: 804, cat: "Economia", en: "Side hustle", pt: "Bico / Renda extra", ctx: "Trabalho extra al√©m do principal.", exs: ["Uber is his side hustle.", "Do you have a side hustle?"] },
            { id: 805, cat: "Economia", en: "Rip-off", pt: "Roubo (muito caro)", ctx: "G√≠ria para algo que n√£o vale o pre√ßo.", exs: ["That phone is a rip-off.", "50 dollars? What a rip-off!"] }
        ];

        // --- ESTADO DO APP ---
        let userCards = JSON.parse(localStorage.getItem('englishApp_v5')) || [];
        let currentCat = localStorage.getItem('englishApp_lastCat') || 'all'; // Restaura Categoria
        let searchTerm = "";
        let reviewQueue = [];
        let currentReviewIndex = 0;
        let activeCardId = null;
        let tempExample = "";

        // --- INICIALIZA√á√ÉO ---
        window.onload = () => {
            updateReviewBadge();
            
            // Restaura visual da categoria ativa
            document.querySelectorAll('.cat-chip').forEach(btn => {
                btn.classList.remove('active');
                const btnTxt = btn.innerText;
                if((currentCat === 'all' && btnTxt === 'Todos') || btnTxt === currentCat) {
                    btn.classList.add('active');
                }
            });

            renderFeed();

            // Restaura Posi√ß√£o do Scroll (PERSIST√äNCIA)
            const savedScroll = localStorage.getItem('englishApp_scrollPos');
            if(savedScroll) {
                setTimeout(() => {
                    document.getElementById('viewExplore').scrollTop = savedScroll;
                }, 100); // Pequeno delay para garantir renderiza√ß√£o
            }
        };

        // Salvar posi√ß√£o de scroll ao rolar
        document.getElementById('viewExplore').onscroll = function() {
            localStorage.setItem('englishApp_scrollPos', this.scrollTop);
        };

        // --- BUSCA E FILTRO ---
        function filterCat(cat, btn) {
            currentCat = cat;
            localStorage.setItem('englishApp_lastCat', cat); // Salva categoria
            document.querySelectorAll('.cat-chip').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            renderFeed();
        }

        function handleSearch(text) {
            searchTerm = text.toLowerCase();
            renderFeed();
        }

        function generateCard() {
            const existingIds = userCards.map(c => c.id);
            let availablePool = db.filter(item => {
                const isCatMatch = currentCat === 'all' || item.cat === currentCat;
                const isNew = !existingIds.includes(item.id);
                return isCatMatch && isNew;
            });
            
            if(availablePool.length === 0) {
                alert("Voc√™ j√° baixou todas as frases dispon√≠veis nesta categoria! Tente outra.");
                return;
            }

            const item = availablePool[Math.floor(Math.random() * availablePool.length)];

            const newCard = {
                uid: Date.now().toString(),
                id: item.id,
                cat: item.cat,
                en: item.en,
                pt: item.pt,
                ctx: item.ctx,
                savedExs: [],
                nextReview: Date.now(),
                interval: 1,
                isHard: false
            };

            userCards.unshift(newCard);
            saveData();
            renderFeed();
            updateReviewBadge();
            
            document.getElementById('viewExplore').scrollTo({ top: 0, behavior: 'smooth' });
        }

        function renderFeed() {
            const feed = document.getElementById('feedList');
            feed.innerHTML = '';

            // L√≥gica combinada de Filtro: Categoria + Busca
            const filtered = userCards.filter(c => {
                const matchCat = currentCat === 'all' || c.cat === currentCat;
                const matchSearch = c.en.toLowerCase().includes(searchTerm) || 
                                    c.pt.toLowerCase().includes(searchTerm) || 
                                    c.ctx.toLowerCase().includes(searchTerm);
                return matchCat && matchSearch;
            });

            if(filtered.length === 0) {
                feed.innerHTML = '<div style="text-align:center; color:#999; margin-top:30px;">Nenhum card encontrado.</div>';
                return;
            }

            // Loop para renderizar
            filtered.forEach((card, index) => {
                // Numera√ß√£o Absoluta: Baseada no total de cards do usu√°rio (Card mais antigo √© #1)
                // userCards est√° ordem decrescente (novo -> velho). 
                // Ent√£o o indice "real" reverso √© userCards.length - indexReal. 
                // Mas aqui estamos iterando o filtered. Para mostrar o n√∫mero real, precisamos achar o indice no array principal.
                const realIndex = userCards.findIndex(uc => uc.uid === card.uid);
                const cardNumber = userCards.length - realIndex;

                const exsHTML = card.savedExs.map(ex => `
                    <div class="post-it">
                        <span>üìù ${ex}</span>
                        <button onclick="speak('${ex.replace(/'/g, "\\'")}')" style="border:none; background:none;">üîä</button>
                    </div>
                `).join('');

                const html = `
                    <div class="card ${card.isHard ? 'hard-mode' : ''}">
                        <div class="card-number">#${cardNumber}</div>
                        
                        <div class="card-header-row">
                            <span class="card-cat">${card.cat}</span>
                            <button class="toggle-hard-btn" onclick="toggleHard('${card.uid}')">
                                ${card.isHard ? '‚òÖ DIF√çCIL' : '‚òÜ Marcar Dif√≠cil'}
                            </button>
                        </div>

                        <div class="en-text">${card.en}</div>
                        <div class="pt-text">${card.pt}</div>
                        
                        <div class="ctx-box">
                            <strong>Contexto:</strong> ${card.ctx}
                        </div>

                        <div class="post-it-container">
                            ${exsHTML}
                        </div>

                        <div class="card-actions">
                            <button class="act-btn" onclick="speak('${card.en.replace(/'/g, "\\'")}')">üîä Ouvir</button>
                            <button class="act-btn" onclick="openModal('${card.uid}')">‚ûï Post-it Exemplo</button>
                            <button class="act-btn" style="color:red; margin-left:auto;" onclick="deleteCard('${card.uid}')">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
                feed.innerHTML += html;
            });
        }

        function toggleHard(uid) {
            const card = userCards.find(c => c.uid === uid);
            if(card) {
                card.isHard = !card.isHard;
                if(card.isHard) { card.interval = 1; card.nextReview = Date.now(); }
                saveData();
                renderFeed();
                updateReviewBadge();
            }
        }

        // --- SRS / REVIS√ÉO ---
        function switchView(view) {
            const vExp = document.getElementById('viewExplore');
            const vRev = document.getElementById('viewReview');
            const hExp = document.getElementById('headerExplore');
            
            if(view === 'explore') {
                vExp.classList.remove('hidden');
                hExp.classList.remove('hidden');
                vRev.classList.add('hidden');
                document.getElementById('navExp').classList.add('active');
                document.getElementById('navRev').classList.remove('active');
                renderFeed(); 
            } else {
                vExp.classList.add('hidden');
                hExp.classList.add('hidden');
                vRev.classList.remove('hidden');
                document.getElementById('navExp').classList.remove('active');
                document.getElementById('navRev').classList.add('active');
                startReview();
            }
        }

        function startReview() {
            const now = Date.now();
            reviewQueue = userCards.filter(c => c.nextReview <= now);
            currentReviewIndex = 0;
            renderReviewCard();
        }

        function renderReviewCard() {
            const container = document.getElementById('reviewContainer');
            
            if(reviewQueue.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center;">
                        <div style="font-size:50px;">üéâ</div>
                        <h2>Tudo em dia!</h2>
                        <p>Voc√™ n√£o tem revis√µes pendentes agora.</p>
                        <button onclick="switchView('explore')" class="act-btn" style="margin:20px auto; background:black; color:white;">Voltar para Explorar</button>
                    </div>
                `;
                return;
            }

            if(currentReviewIndex >= reviewQueue.length) {
                container.innerHTML = `
                    <div style="text-align:center;">
                        <h2>Sess√£o Conclu√≠da!</h2>
                        <p>Volte amanh√£ para mais.</p>
                        <button onclick="switchView('explore')" class="act-btn" style="margin:20px auto; background:black; color:white;">Voltar</button>
                    </div>
                `;
                return;
            }

            const card = reviewQueue[currentReviewIndex];
            
            container.innerHTML = `
                <div class="flashcard">
                    <span style="font-size:12px; color:#999; text-transform:uppercase;">${card.cat}</span>
                    <h2 style="font-size:28px; color:var(--primary); margin:20px 0;">${card.en}</h2>
                    <button class="act-btn" style="margin:0 auto;" onclick="speak('${card.en.replace(/'/g, "\\'")}')">üîä Ouvir</button>
                    
                    <button id="revealBtn" onclick="document.getElementById('hiddenArea').classList.add('visible'); this.style.display='none';" style="margin-top:40px; background:black; color:white; padding:15px; border:none; border-radius:15px; width:100%; font-weight:bold;">
                        üëÅÔ∏è Mostrar Resposta
                    </button>

                    <div id="hiddenArea" class="hidden-content">
                        <div style="font-size:20px; font-weight:500; margin-bottom:10px;">${card.pt}</div>
                        <div style="color:#666; font-size:14px;">${card.ctx}</div>
                        
                        <div class="srs-btns">
                            <button class="srs-btn" style="background:var(--red);" onclick="processSRS('hard')">Dif√≠cil ü•µ</button>
                            <button class="srs-btn" style="background:var(--green);" onclick="processSRS('easy')">F√°cil üòé</button>
                        </div>
                    </div>
                </div>
                <p style="margin-top:20px; color:#666;">Card ${currentReviewIndex + 1} de ${reviewQueue.length}</p>
            `;
        }

        function processSRS(difficulty) {
            const card = reviewQueue[currentReviewIndex];
            const realCard = userCards.find(c => c.uid === card.uid);

            if (difficulty === 'hard') {
                realCard.interval = 1;
                realCard.isHard = true; 
            } else {
                realCard.interval = Math.ceil(realCard.interval * 2);
                realCard.isHard = false;
            }

            realCard.nextReview = Date.now() + (realCard.interval * 24 * 60 * 60 * 1000);
            saveData();
            currentReviewIndex++;
            renderReviewCard();
            updateReviewBadge();
        }

        // --- MODAL / AUXILIARES ---
        function openModal(uid) {
            activeCardId = uid;
            document.getElementById('modalEx').classList.add('show');
            cycleModal();
        }
        
        function cycleModal() {
            if(!activeCardId) return;
            const card = userCards.find(c => c.uid === activeCardId);
            const dbItem = db.find(i => i.id === card.id);
            const rand = dbItem.exs[Math.floor(Math.random() * dbItem.exs.length)];
            tempExample = rand;
            document.getElementById('modalText').innerText = `"${rand}"`;
        }

        function speakModal() { speak(tempExample); }

        function saveModal() {
            const card = userCards.find(c => c.uid === activeCardId);
            if(card) {
                card.savedExs.push(tempExample);
                saveData();
                renderFeed();
                closeModal();
            }
        }

        function closeModal() {
            document.getElementById('modalEx').classList.remove('show');
            activeCardId = null;
        }

        // --- BACKUP ---
        function backupData() {
            const dataStr = JSON.stringify(userCards);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', 'meus_cards_ingles.json');
            linkElement.click();
        }

        function restoreData(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if(Array.isArray(data)) {
                        if(confirm("Substituir dados atuais pelo backup?")) {
                            userCards = data;
                            saveData();
                            location.reload();
                        }
                    } else { alert("Arquivo inv√°lido."); }
                } catch(err) { alert("Erro ao ler o arquivo."); }
            };
            reader.readAsText(file);
        }

        // --- UTIL ---
        function updateReviewBadge() {
            const now = Date.now();
            const count = userCards.filter(c => c.nextReview <= now).length;
            const badge = document.getElementById('revBadge');
            if(count > 0) {
                badge.innerText = count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function deleteCard(uid) {
            if(confirm("Apagar este card?")) {
                userCards = userCards.filter(c => c.uid !== uid);
                saveData();
                renderFeed();
                updateReviewBadge();
            }
        }

        function speak(text) {
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'en-US';
            window.speechSynthesis.speak(u);
        }

        function saveData() {
            localStorage.setItem('englishApp_v5', JSON.stringify(userCards));
        }

    </script>
</body>
</html>